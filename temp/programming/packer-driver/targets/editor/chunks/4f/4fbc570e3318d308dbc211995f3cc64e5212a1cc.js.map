{"version":3,"sources":["file:///D:/dev/%E6%96%B0%E5%BB%BA%E6%96%87%E4%BB%B6%E5%A4%B9/NewProject/assets/Script/View/GridView.ts"],"names":["_decorator","Component","Node","AudioUtils","ccclass","property","GridView","cc","Prefab","onLoad","setController","controller","initWithCellModels","cellsModels","setListener","convertTouchPosToCell","pos","updateView","changeModels","updateSelect","findViewByModel","model","getPlayAniTime","getStep","effectsQueue","disableTouch","time","step","selectCell","cellPos","playEffect"],"mappings":";;;;;;;;;;;;;;;;;;;;;;AAGSA,MAAAA,U,OAAAA,U;AAAYC,MAAAA,S,OAAAA,S;AAAWC,MAAAA,I,OAAAA,I;;AAIzBC,MAAAA,U;;;;;;AAPP;AACA;AACA;;;;;OAEM;AAAEC,QAAAA,OAAF;AAAWC,QAAAA;AAAX,O,GAAwBL,U;;0BAKjBM,Q,WADZF,OAAO,CAAC,UAAD,C,UAEHC,QAAQ,CAAC,CAACE,EAAE,CAACC,MAAJ,CAAD,C,UAERH,QAAQ,CAACH,IAAD,C,UAERG,QAAQ;AAAA;AAAA,mC,2BANb,MACaC,QADb,SAC8BL,SAD9B,CACwC;AAAA;AAAA;;AAAA;;AAAA;;AAAA;AAAA;;AAQpCQ,QAAAA,MAAM,GAAI,CACN;AACA;AACA;AACA;AACH;;AAEDC,QAAAA,aAAa,CAAEC,UAAF,EAAmB,CAC5B;AACH;;AAEDC,QAAAA,kBAAkB,CAAEC,WAAF,EAAoB,CAClC;AACA;AACI;AACA;AACI;AACA;AACA;AACA;AACA;AACA;AACJ;AACJ;AACH;;AAEDC,QAAAA,WAAW,GAAI,CACX;AACI;AACI;AACJ;AACA;AACA;AACA;AACI;AACA;AACJ;AACA;AACI;AACJ;AACD;AACH;AACA;AACG;AACI;AACA;AACA;AACA;AACA;AACI;AACA;AACJ;AACJ;AACH;AACA;AACA;AACA;AACA;AACH;;AAEDC,QAAAA,qBAAqB,CAAEC,GAAF,EAAY,CAC7B;AACA;AACI;AACJ;AACA;AACA;AACA;AACH;;AAEDC,QAAAA,UAAU,CAAEC,YAAF,EAAqB,CAC3B;AACA;AACI;AACA;AACA;AACA;AACI;AACA;AACA;AACA;AACA;AACA;AACJ;AACA;AACI;AACA;AACJ;AACA;AACA;AACA;AACI;AACI;AACA;AACJ;AACJ;AACJ;AACA;AACI;AACA;AACJ;AACH;;AAEDC,QAAAA,YAAY,CAAEH,GAAF,EAAY,CACnB;AACG;AACI;AACI;AACA;AACI;AACJ;AACA;AACI;AACJ;AACJ;AACJ;AACJ;AACH;;AAEDI,QAAAA,eAAe,CAAEC,KAAF,EAAc,CACzB;AACI;AACI;AACI;AACJ;AACJ;AACJ;AACA;AACH;;AAEDC,QAAAA,cAAc,CAAEJ,YAAF,EAAqB,CAC/B;AACI;AACJ;AACA;AACA;AACI;AACI;AACI;AACJ;AACJ;AACJ;AACA;AACH;;AAEDK,QAAAA,OAAO,CAAEC,YAAF,EAAqB,CACxB;AACI;AACJ;AACA;AACI;AACJ;AACH;;AAEDC,QAAAA,YAAY,CAAEC,IAAF,EAAaC,IAAb,EAAwB,CAChC;AACI;AACJ;AACA;AACA;AACI;AACA;AACJ;AACH;;AAEDC,QAAAA,UAAU,CAAEC,OAAF,EAAgB,CACtB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACI;AACA;AACJ;AACA;AACI;AACA;AACJ;AACA;AACH;;AAEDC,QAAAA,UAAU,CAAEN,YAAF,EAAqB,CAC3B;AACH;;AAlMmC,O;;;;;iBAEpB,E;;;;;;;iBAEK,I;;;;;;;iBAED,I;;;AAiMxB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","sourcesContent":["/**\n* 根据cell的model返回对应的view\n*/\nimport { _decorator, Component, Node } from 'cc';\nconst { ccclass, property } = _decorator;\n\nimport {CELL_WIDTH, CELL_HEIGHT, GRID_PIXEL_WIDTH, GRID_PIXEL_HEIGHT, ANITIME} from '../Model/ConstValue';\nimport AudioUtils from \"../Utils/AudioUtils\";\n@ccclass('GridView')\nexport class GridView extends Component {\n    @property([cc.Prefab])\n    public aniPre = [];\n    @property(Node)\n    public effectLayer = null;\n    @property(AudioUtils)\n    public audioUtils = null;\n\n    onLoad () {\n        // this.setListener(); \n        // this.lastTouchPos = cc.Vec2(-1, -1); \n        // this.isCanMove = true; \n        // this.isInPlayAni = false; // 是否在播放中 \n    }\n\n    setController (controller: any) {\n        // this.controller = controller; \n    }\n\n    initWithCellModels (cellsModels: any) {\n        // this.cellViews = []; \n        // for(var i = 1;i<=9;i++){ \n            // this.cellViews[i] = []; \n            // for(var j = 1;j<=9;j++){ \n                // var type = cellsModels[i][j].type; \n                // var aniView = cc.instantiate(this.aniPre[type]); \n                // aniView.parent = this.node; \n                // var cellViewScript = aniView.getComponent(\"CellView\"); \n                // cellViewScript.initWithModel(cellsModels[i][j]); \n                // this.cellViews[i][j] = aniView; \n            // } \n        // } \n    }\n\n    setListener () {\n        // this.node.on(cc.Node.EventType.TOUCH_START, function(eventTouch){ \n            // if(this.isInPlayAni){//播放动画中，不允许点击 \n                // return true; \n            // } \n            // var touchPos = eventTouch.getLocation(); \n            // var cellPos = this.convertTouchPosToCell(touchPos); \n            // if(cellPos){ \n                // var changeModels = this.selectCell(cellPos); \n                // this.isCanMove = changeModels.length < 3; \n            // } \n            // else{ \n                // this.isCanMove = false; \n            // } \n           // return true; \n        // }, this); \n        // this.node.on(cc.Node.EventType.TOUCH_MOVE, function(eventTouch){ \n           // if(this.isCanMove){ \n               // var startTouchPos = eventTouch.getStartLocation (); \n               // var startCellPos = this.convertTouchPosToCell(startTouchPos); \n               // var touchPos = eventTouch.getLocation(); \n               // var cellPos = this.convertTouchPosToCell(touchPos); \n               // if(startCellPos.x != cellPos.x || startCellPos.y != cellPos.y){ \n                   // this.isCanMove = false; \n                   // var changeModels = this.selectCell(cellPos);  \n               // } \n           // } \n        // }, this); \n        // this.node.on(cc.Node.EventType.TOUCH_END, function(eventTouch){ \n        // }, this); \n        // this.node.on(cc.Node.EventType.TOUCH_CANCEL, function(eventTouch){ \n        // }, this); \n    }\n\n    convertTouchPosToCell (pos: any) {\n        // pos = this.node.convertToNodeSpace(pos); \n        // if(pos.x < 0 || pos.x >= GRID_PIXEL_WIDTH || pos.y < 0 || pos.y >= GRID_PIXEL_HEIGHT){ \n            // return false; \n        // } \n        // var x = Math.floor(pos.x / CELL_WIDTH) + 1; \n        // var y = Math.floor(pos.y / CELL_HEIGHT) + 1; \n        // return cc.v2(x, y); \n    }\n\n    updateView (changeModels: any) {\n        // let newCellViewInfo = []; \n        // for(var i in changeModels){ \n            // var model = changeModels[i]; \n            // var viewInfo = this.findViewByModel(model); \n            // var view = null; \n            // if(!viewInfo){ \n                // var type = model.type; \n                // var aniView = cc.instantiate(this.aniPre[type]); \n                // aniView.parent = this.node; \n                // var cellViewScript = aniView.getComponent(\"CellView\"); \n                // cellViewScript.initWithModel(model); \n                // view = aniView; \n            // } \n            // else{ \n                // view = viewInfo.view; \n                // this.cellViews[viewInfo.y][viewInfo.x] = null; \n            // } \n            // var cellScript = view.getComponent(\"CellView\"); \n            // cellScript.updateView();// 执行移动动作 \n            // if (!model.isDeath) { \n                // newCellViewInfo.push({ \n                    // model: model, \n                    // view: view \n                // }); \n            // }  \n        // } \n        // newCellViewInfo.forEach(function(ele){ \n            // let model = ele.model; \n            // this.cellViews[model.y][model.x] = ele.view; \n        // },this); \n    }\n\n    updateSelect (pos: any) {\n         // for(var i = 1;i <=9 ;i++){ \n            // for(var j = 1 ;j <=9 ;j ++){ \n                // if(this.cellViews[i][j]){ \n                    // var cellScript = this.cellViews[i][j].getComponent(\"CellView\"); \n                    // if(pos.x == j && pos.y ==i){ \n                        // cellScript.setSelect(true); \n                    // } \n                    // else{ \n                        // cellScript.setSelect(false); \n                    // } \n                // } \n            // } \n        // } \n    }\n\n    findViewByModel (model: any) {\n        // for(var i = 1;i <=9 ;i++){ \n            // for(var j = 1 ;j <=9 ;j ++){ \n                // if(this.cellViews[i][j] && this.cellViews[i][j].getComponent(\"CellView\").model == model){ \n                    // return {view:this.cellViews[i][j],x:j, y:i}; \n                // } \n            // } \n        // } \n        // return null; \n    }\n\n    getPlayAniTime (changeModels: any) {\n        // if(!changeModels){ \n            // return 0; \n        // } \n        // var maxTime = 0; \n        // changeModels.forEach(function(ele){ \n            // ele.cmd.forEach(function(cmd){ \n                // if(maxTime < cmd.playTime + cmd.keepTime){ \n                    // maxTime = cmd.playTime + cmd.keepTime; \n                // } \n            // },this) \n        // },this); \n        // return maxTime; \n    }\n\n    getStep (effectsQueue: any) {\n        // if(!effectsQueue){ \n            // return 0; \n        // } \n        // return effectsQueue.reduce(function(maxValue, efffectCmd){ \n            // return Math.max(maxValue, efffectCmd.step || 0); \n        // }, 0); \n    }\n\n    disableTouch (time: any, step: any) {\n        // if(time <= 0){ \n            // return ; \n        // } \n        // this.isInPlayAni = true; \n        // this.node.runAction(cc.sequence(cc.delayTime(time),cc.callFunc(function(){ \n            // this.isInPlayAni = false; \n            // this.audioUtils.playContinuousMatch(step); \n        // }, this))); \n    }\n\n    selectCell (cellPos: any) {\n        // var result = this.controller.selectCell(cellPos); // 直接先丢给model处理数据逻辑 \n        // var changeModels = result[0]; // 有改变的cell，包含新生成的cell和生成马上摧毁的格子 \n        // var effectsQueue = result[1]; //各种特效 \n        // this.playEffect(effectsQueue); \n        // this.disableTouch(this.getPlayAniTime(changeModels), this.getStep(effectsQueue)); \n        // this.updateView(changeModels); \n        // this.controller.cleanCmd();  \n        // if(changeModels.length >= 2){ \n            // this.updateSelect(cc.v2(-1,-1)); \n            // this.audioUtils.playSwap(); \n        // } \n        // else{ \n            // this.updateSelect(cellPos); \n            // this.audioUtils.playClick(); \n        // } \n        // return changeModels; \n    }\n\n    playEffect (effectsQueue: any) {\n        // this.effectLayer.getComponent(\"EffectLayer\").playEffects(effectsQueue); \n    }\n\n}\n\n\n/**\n * 注意：已把原脚本注释，由于脚本变动过大，转换的时候可能有遗落，需要自行手动转换\n */\n// import {CELL_WIDTH, CELL_HEIGHT, GRID_PIXEL_WIDTH, GRID_PIXEL_HEIGHT, ANITIME} from '../Model/ConstValue';\r\n// \r\n// import AudioUtils from \"../Utils/AudioUtils\";\r\n// \r\n// cc.Class({\r\n//     extends: cc.Component,\r\n// \r\n//     properties: {\r\n//         // foo: {\r\n//         //    default: null,      // The default value will be used only when the component attaching\r\n//         //                           to a node for the first time\r\n//         //    url: cc.Texture2D,  // optional, default is typeof default\r\n//         //    serializable: true, // optional, default is true\r\n//         //    visible: true,      // optional, default is true\r\n//         //    displayName: 'Foo', // optional\r\n//         //    readonly: false,    // optional, default is false\r\n//         // },\r\n//         // ...\r\n//         aniPre: {\r\n//             default: [],\r\n//             type: [cc.Prefab]\r\n//         },\r\n//         effectLayer: {\r\n//             default: null,\r\n//             type: cc.Node\r\n//         },\r\n//         audioUtils:{\r\n//             type: AudioUtils,\r\n//             default: null\r\n//         }\r\n//         \r\n//     },\r\n// \r\n// \r\n//     // use this for initialization\r\n//     onLoad: function () {\r\n//         this.setListener();\r\n//         this.lastTouchPos = cc.Vec2(-1, -1);\r\n//         this.isCanMove = true;\r\n//         this.isInPlayAni = false; // 是否在播放中\r\n//     },\r\n//     setController: function(controller){\r\n//         this.controller = controller;\r\n//     },\r\n// \r\n//     initWithCellModels: function(cellsModels){\r\n//         this.cellViews = [];\r\n//         for(var i = 1;i<=9;i++){\r\n//             this.cellViews[i] = [];\r\n//             for(var j = 1;j<=9;j++){\r\n//                 var type = cellsModels[i][j].type;\r\n//                 var aniView = cc.instantiate(this.aniPre[type]);\r\n//                 aniView.parent = this.node;\r\n//                 var cellViewScript = aniView.getComponent(\"CellView\");\r\n//                 cellViewScript.initWithModel(cellsModels[i][j]);\r\n//                 this.cellViews[i][j] = aniView;\r\n//             }\r\n//         }\r\n//     },\r\n//     setListener: function(){\r\n//         this.node.on(cc.Node.EventType.TOUCH_START, function(eventTouch){\r\n//             if(this.isInPlayAni){//播放动画中，不允许点击\r\n//                 return true;\r\n//             }\r\n//             var touchPos = eventTouch.getLocation();\r\n//             var cellPos = this.convertTouchPosToCell(touchPos);\r\n//             if(cellPos){\r\n//                 var changeModels = this.selectCell(cellPos);\r\n//                 this.isCanMove = changeModels.length < 3;\r\n//             }\r\n//             else{\r\n//                 this.isCanMove = false;\r\n//             }\r\n//            return true;\r\n//         }, this);\r\n//         // 滑动操作逻辑\r\n//         this.node.on(cc.Node.EventType.TOUCH_MOVE, function(eventTouch){\r\n//            if(this.isCanMove){\r\n//                var startTouchPos = eventTouch.getStartLocation ();\r\n//                var startCellPos = this.convertTouchPosToCell(startTouchPos);\r\n//                var touchPos = eventTouch.getLocation();\r\n//                var cellPos = this.convertTouchPosToCell(touchPos);\r\n//                if(startCellPos.x != cellPos.x || startCellPos.y != cellPos.y){\r\n//                    this.isCanMove = false;\r\n//                    var changeModels = this.selectCell(cellPos); \r\n//                }\r\n//            }\r\n//         }, this);\r\n//         this.node.on(cc.Node.EventType.TOUCH_END, function(eventTouch){\r\n//           // console.log(\"1111\");\r\n//         }, this);\r\n//         this.node.on(cc.Node.EventType.TOUCH_CANCEL, function(eventTouch){\r\n//           // console.log(\"1111\");\r\n//         }, this);\r\n//     },\r\n//     // 根据点击的像素位置，转换成网格中的位置\r\n//     convertTouchPosToCell: function(pos){\r\n//         pos = this.node.convertToNodeSpace(pos);\r\n//         if(pos.x < 0 || pos.x >= GRID_PIXEL_WIDTH || pos.y < 0 || pos.y >= GRID_PIXEL_HEIGHT){\r\n//             return false;\r\n//         }\r\n//         var x = Math.floor(pos.x / CELL_WIDTH) + 1;\r\n//         var y = Math.floor(pos.y / CELL_HEIGHT) + 1;\r\n//         return cc.v2(x, y);\r\n//     },\r\n//     // 移动格子\r\n//     updateView: function(changeModels){\r\n//         let newCellViewInfo = [];\r\n//         for(var i in changeModels){\r\n//             var model = changeModels[i];\r\n//             var viewInfo = this.findViewByModel(model);\r\n//             var view = null;\r\n//             // 如果原来的cell不存在，则新建\r\n//             if(!viewInfo){\r\n//                 var type = model.type;\r\n//                 var aniView = cc.instantiate(this.aniPre[type]);\r\n//                 aniView.parent = this.node;\r\n//                 var cellViewScript = aniView.getComponent(\"CellView\");\r\n//                 cellViewScript.initWithModel(model);\r\n//                 view = aniView;\r\n//             }\r\n//             // 如果已经存在\r\n//             else{\r\n//                 view = viewInfo.view;\r\n//                 this.cellViews[viewInfo.y][viewInfo.x] = null;\r\n//             }\r\n//             var cellScript = view.getComponent(\"CellView\");\r\n//             cellScript.updateView();// 执行移动动作\r\n//             if (!model.isDeath) {\r\n//                 newCellViewInfo.push({\r\n//                     model: model,\r\n//                     view: view\r\n//                 });\r\n//             } \r\n//         }\r\n//         // 重新标记this.cellviews的信息\r\n//         newCellViewInfo.forEach(function(ele){\r\n//             let model = ele.model;\r\n//             this.cellViews[model.y][model.x] = ele.view;\r\n//         },this);\r\n//     },\r\n//     // 显示选中的格子背景\r\n//     updateSelect: function(pos){\r\n//          for(var i = 1;i <=9 ;i++){\r\n//             for(var j = 1 ;j <=9 ;j ++){\r\n//                 if(this.cellViews[i][j]){\r\n//                     var cellScript = this.cellViews[i][j].getComponent(\"CellView\");\r\n//                     if(pos.x == j && pos.y ==i){\r\n//                         cellScript.setSelect(true);\r\n//                     }\r\n//                     else{\r\n//                         cellScript.setSelect(false);\r\n//                     }\r\n// \r\n//                 }\r\n//             }\r\n//         }\r\n//         \r\n//     },\r\n//     /**\r\n//      * 根据cell的model返回对应的view\r\n//      */\r\n//     findViewByModel: function(model){\r\n//         for(var i = 1;i <=9 ;i++){\r\n//             for(var j = 1 ;j <=9 ;j ++){\r\n//                 if(this.cellViews[i][j] && this.cellViews[i][j].getComponent(\"CellView\").model == model){\r\n//                     return {view:this.cellViews[i][j],x:j, y:i};\r\n//                 }\r\n//             }\r\n//         }\r\n//         return null;\r\n//     },\r\n//     getPlayAniTime: function(changeModels){\r\n//         if(!changeModels){\r\n//             return 0;\r\n//         }\r\n//         var maxTime = 0;\r\n//         changeModels.forEach(function(ele){\r\n//             ele.cmd.forEach(function(cmd){\r\n//                 if(maxTime < cmd.playTime + cmd.keepTime){\r\n//                     maxTime = cmd.playTime + cmd.keepTime;\r\n//                 }\r\n//             },this)\r\n//         },this);\r\n//         return maxTime;\r\n//     },\r\n//     // 获得爆炸次数， 同一个时间算一个\r\n//     getStep: function(effectsQueue){\r\n//         if(!effectsQueue){\r\n//             return 0;\r\n//         }\r\n//         return effectsQueue.reduce(function(maxValue, efffectCmd){\r\n//             return Math.max(maxValue, efffectCmd.step || 0);\r\n//         }, 0);\r\n//     },\r\n//     //一段时间内禁止操作\r\n//     disableTouch: function(time, step){\r\n//         if(time <= 0){\r\n//             return ;\r\n//         }\r\n//         this.isInPlayAni = true;\r\n//         this.node.runAction(cc.sequence(cc.delayTime(time),cc.callFunc(function(){\r\n//             this.isInPlayAni = false;\r\n//             this.audioUtils.playContinuousMatch(step);\r\n//         }, this)));\r\n//     },\r\n//     // 正常击中格子后的操作\r\n//     selectCell: function(cellPos){\r\n//         var result = this.controller.selectCell(cellPos); // 直接先丢给model处理数据逻辑\r\n//         var changeModels = result[0]; // 有改变的cell，包含新生成的cell和生成马上摧毁的格子\r\n//         var effectsQueue = result[1]; //各种特效\r\n//         this.playEffect(effectsQueue);\r\n//         this.disableTouch(this.getPlayAniTime(changeModels), this.getStep(effectsQueue));\r\n//         this.updateView(changeModels);\r\n//         this.controller.cleanCmd(); \r\n//         if(changeModels.length >= 2){\r\n//             this.updateSelect(cc.v2(-1,-1));\r\n//             this.audioUtils.playSwap();\r\n//         }\r\n//         else{\r\n//             this.updateSelect(cellPos);\r\n//             this.audioUtils.playClick();\r\n//         }\r\n//         return changeModels;\r\n//     },\r\n//     playEffect: function(effectsQueue){\r\n//         this.effectLayer.getComponent(\"EffectLayer\").playEffects(effectsQueue);\r\n//     }\r\n// \r\n// \r\n// \r\n// \r\n//     // called every frame, uncomment this function to activate update callback\r\n//     // update: function (dt) {\r\n// \r\n//     // },\r\n// });\n"]}