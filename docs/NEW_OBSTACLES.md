# New Obstacle Types Implementation

## Overview

This document describes the implementation of three new obstacle mechanics for the match-3 game:

1. **Movable Obstacles (Rock)** - Stone blocks that fall with gravity during elimination
2. **Multi-level Obstacles** - Obstacles with multiple HP levels that degrade step by step
3. **Periodic Obstacles** - Obstacles that spawn automatically every N moves

## Implementation Details

### 1. Movable Obstacles (Rock)

**Behavior**: Rock obstacles occupy cells and can fall down when cells below them are cleared, similar to how normal game pieces fall.

**Files Modified**:
- `CellModel.ts`: Added `isMovable` property
- `GameModel.ts`: 
  - Modified `down()` to allow movable rocks to fall
  - Added rock obstacle type handling in `init()` and `crushCell()`
  - Updated `checkPoint()` and `checkWithDirection()` to prevent matching through rocks
- `CellView.ts`: Added rock sprite loading
- `LevelConfig.ts`: Added `movable?: boolean` to `LevelObstacle` interface

**Level Configuration Example**:
```json
{
  "obstacles": [
    {
      "type": "rock",
      "hp": 1,
      "movable": true,
      "positions": [[3, 3], [7, 3]]
    }
  ]
}
```

**Assets**: 
- `assets/resources/obstacles/rock.png` - Rock emoji (1FAA8.png from openemoji)

### 2. Multi-level Obstacles

**Behavior**: Obstacles that require multiple eliminations to remove. Each adjacent match reduces HP by 1. Visual opacity changes based on remaining HP.

**Files Modified**:
- `GameModel.ts`: Added `multilevel` obstacle type handling in `crushCell()`
- `CellView.ts`: Added opacity variation based on obstacle HP level
- `LevelConfig.ts`: Added `multilevel` to obstacle types

**Level Configuration Example**:
```json
{
  "obstacles": [
    {
      "type": "multilevel",
      "hp": 3,
      "positions": [[5, 5]]
    }
  ]
}
```

**Visual Feedback**:
- Opacity increases with HP: `opacity = min(255, 120 + hp * 35)`
- HP 1: ~155 opacity
- HP 2: ~190 opacity
- HP 3: ~225 opacity
- HP 4+: 255 opacity

**Assets**:
- `assets/resources/obstacles/collision.png` - Collision emoji (1F4A5.png from openemoji)

### 3. Periodic Obstacles

**Behavior**: New obstacles spawn on random empty cells every N moves. UI refreshes to show the new obstacles with a subtle animation.

**Files Modified**:
- `LevelConfig.ts`: Added `LevelPeriodicObstacle` interface and `periodicObstacles` field
- `LevelState.ts`: 
  - Added `moveCount` counter
  - Added `shouldSpawnPeriodicObstacle()` method
  - Modified `useMove()` and `tick()` to increment move counter
- `GameModel.ts`: Added `spawnPeriodicObstacle()` method
- `GameController.ts`: Added spawn checking and UI hint in `updateLevelState()`
- `GridView.ts`: Added `refreshAllCells()` method for UI updates

**Level Configuration Example**:
```json
{
  "periodicObstacles": [
    {
      "type": "ice",
      "interval": 5,
      "hp": 1,
      "maxCount": 2
    }
  ]
}
```

**Parameters**:
- `type`: The obstacle type to spawn (ice, rock, multilevel, etc.)
- `interval`: Spawn new obstacles every N moves
- `hp`: Initial HP of spawned obstacles
- `maxCount`: Maximum number of obstacles to spawn per trigger (default: 3)

### 4. Test Levels

The first three levels have been modified to showcase all new obstacle features:

**Level 1**: Basic introduction to movable rocks and periodic spawning
- 2 movable rocks at fixed positions
- 1 multi-level obstacle (HP 3)
- Ice spawns every 5 moves

**Level 2**: Focus on multi-level obstacles
- 2 multi-level obstacles (HP 4)
- 2 movable rocks
- Multi-level obstacles spawn periodically every 8 moves

**Level 3**: All features combined
- 4 movable rocks at corners
- 1 multi-level obstacle in center
- 2 crates
- Ice spawns every 6 moves

## Testing Instructions

1. Open the project in Cocos Creator 3.8.6
2. The assets in `assets/resources/obstacles/` may need to be re-imported (the .meta files will be generated by Creator)
3. Run the game and start Level 1, 2, or 3
4. Test each mechanic:
   - **Movable rocks**: Make matches below rocks and watch them fall
   - **Multi-level obstacles**: Make adjacent matches and see HP decrease (visual opacity changes)
   - **Periodic obstacles**: Play several moves and observe new obstacles spawning

## Technical Notes

### Movable vs Non-Movable Obstacles

The `isMovable` flag determines whether a rock falls during the `down()` phase:
- `movable: true` - Rock behaves like a game piece and falls when space below is cleared
- `movable: false` or undefined - Rock stays in place (like crate)

### Spawn Logic

Periodic spawning:
1. Checks if `moveCount % interval === 0`
2. Finds all valid empty cells (has type, no obstacle, not locked)
3. Randomly selects up to `maxCount` cells
4. Applies the specified obstacle type with given HP
5. Refreshes all cell views to show changes

### Collision Detection

Rocks and crates are treated similarly in collision detection - they block matches but can be eliminated when adjacent matches occur. Movable rocks differ only in their falling behavior.

## Future Enhancements

Potential improvements:
1. Add animation effects for obstacle spawning (particles, flash, etc.)
2. Add sound effects for different obstacle types
3. Create more obstacle types (explosive, spreading, etc.)
4. Add UI countdown indicator for periodic spawns
5. Add combo multipliers for clearing multiple obstacles

## Asset Credits

All obstacle sprites are from OpenEmoji (https://openmoji.org/):
- Rock: U+1FAA8
- Collision: U+1F4A5
- Clock: U+23F0 (for future use)
